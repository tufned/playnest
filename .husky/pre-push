#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Check for changes in @playnest/core
CHANGED=$(git diff --name-only HEAD~1 HEAD packages/core/ | wc -l)

if [ "$CHANGED" -gt 0 ]; then
  echo "🔍 Changes detected in @playnest/core. Launching publishing..."

  echo "📦 Building..."
  pnpm build --filter @playnest/core

  cd packages/core || exit

  echo "🚀 Updating package version..."
  CURRENT_VERSION=$(node -p "require('./package.json').version")
  NEW_VERSION=$(npm version patch --no-git-tag-version)

  echo "🔄 Updated version: v$CURRENT_VERSION → $NEW_VERSION"

  echo "📤 Publishing $NEW_VERSION to npm..."
  npm publish

  cd ../../

  git add packages/core/package.json
  git commit -m "chore(@playnest/core): version patch [v$CURRENT_VERSION → $NEW_VERSION]"
  git pull --rebase origin "$(git rev-parse --abbrev-ref HEAD)"
  git push --no-verify origin "$(git rev-parse --abbrev-ref HEAD)"

  echo "✅ Published"
else
  echo "ℹ️ No changes in @playnest/core. Skipping publishing"
fi
